name: ğŸš€ Deploy to AWS EC2

# Trigger the workflow on push to main branch and manual dispatch
on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      deploy_message:
        description: 'Deployment message'
        required: false
        default: 'Manual deployment'

# Environment variables
env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  INSTANCE_TAG_NAME: my-webapp-server
  SSH_USER: ec2-user

jobs:
  # Job 1: Run tests and validation
  test:
    name: ğŸ§ª Test & Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Validate HTML
      run: |
        echo "ğŸ” Validating HTML structure..."
        
        # Check if HTML file exists
        if [ ! -f "src/index.html" ]; then
          echo "âŒ HTML file not found!"
          exit 1
        fi
        
        # Basic HTML validation
        if grep -q "<!DOCTYPE html>" src/index.html; then
          echo "âœ… DOCTYPE declaration found"
        else
          echo "âŒ DOCTYPE declaration missing"
          exit 1
        fi
        
        if grep -q "<title>" src/index.html; then
          echo "âœ… Title tag found"
        else
          echo "âŒ Title tag missing"
          exit 1
        fi
        
        if grep -q "DevOps Learning Journey" src/index.html; then
          echo "âœ… Expected content found"
        else
          echo "âŒ Expected content missing"
          exit 1
        fi
        
        echo "âœ… HTML validation passed!"
    
    - name: Check file size
      run: |
        echo "ğŸ“Š Checking file sizes..."
        ls -lh src/
        
        # Ensure HTML file isn't too large (basic check)
        size=$(stat -c%s src/index.html)
        if [ $size -gt 100000 ]; then
          echo "âš ï¸ HTML file is quite large: $size bytes"
        else
          echo "âœ… File size acceptable: $size bytes"
        fi
    
    - name: Security scan
      run: |
        echo "ğŸ”’ Running basic security checks..."
        
        # Check for potential security issues in HTML
        if grep -i "javascript:" src/index.html; then
          echo "âš ï¸ Found javascript: protocol - review for XSS"
        fi
        
        if grep -i "eval(" src/index.html; then
          echo "âš ï¸ Found eval() function - potential security risk"
        fi
        
        if grep -i "innerHTML.*=" src/index.html; then
          echo "âš ï¸ Found innerHTML assignment - review for XSS"
        fi
        
        echo "âœ… Basic security scan completed"

  # Job 2: Deploy to EC2 (only if tests pass)
  deploy:
    name: ğŸš€ Deploy to EC2
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    outputs:
      instance-ip: ${{ steps.deploy.outputs.instance-ip }}
      deployment-time: ${{ steps.deploy.outputs.deployment-time }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Verify AWS connection
      run: |
        echo "ğŸ”§ Verifying AWS connection..."
        aws sts get-caller-identity
        echo "âœ… AWS connection verified"
    
    - name: Set up SSH key
      run: |
        echo "ğŸ”‘ Setting up SSH key..."
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deployment-key.pem
        chmod 400 ~/.ssh/deployment-key.pem
        ssh-keyscan -H $(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=$INSTANCE_TAG_NAME" "Name=instance-state-name,Values=running" \
          --query 'Reservations[0].Instances[0].PublicIpAddress' \
          --output text) >> ~/.ssh/known_hosts 2>/dev/null || true
    
    - name: Get EC2 instance information
      id: instance-info
      run: |
        echo "ğŸ“¡ Getting EC2 instance information..."
        
        INSTANCE_INFO=$(aws ec2 describe-instances \
          --filters "Name=tag:Name,Values=$INSTANCE_TAG_NAME" "Name=instance-state-name,Values=running" \
          --query 'Reservations[0].Instances[0].[InstanceId,PublicIpAddress,State.Name]' \
          --output text)
        
        if [ "$INSTANCE_INFO" = "None	None	None" ]; then
          echo "âŒ No running instance found with tag Name=$INSTANCE_TAG_NAME"
          exit 1
        fi
        
        read INSTANCE_ID INSTANCE_IP STATE <<< "$INSTANCE_INFO"
        
        echo "instance-id=$INSTANCE_ID" >> $GITHUB_OUTPUT
        echo "instance-ip=$INSTANCE_IP" >> $GITHUB_OUTPUT
        echo "state=$STATE" >> $GITHUB_OUTPUT
        
        echo "âœ… Found instance: $INSTANCE_ID ($INSTANCE_IP) - $STATE"
    
    - name: Test SSH connectivity
      run: |
        echo "ğŸ”— Testing SSH connectivity..."
        ssh -i ~/.ssh/deployment-key.pem -o ConnectTimeout=10 -o StrictHostKeyChecking=no \
          $SSH_USER@${{ steps.instance-info.outputs.instance-ip }} \
          "echo 'SSH connection successful'"
        echo "âœ… SSH connection verified"
    
    - name: Create deployment backup
      run: |
        echo "ğŸ’¾ Creating backup of current deployment..."
        
        TIMESTAMP=$(date +%Y%m%d_%H%M%S)
        
        ssh -i ~/.ssh/deployment-key.pem $SSH_USER@${{ steps.instance-info.outputs.instance-ip }} << EOF
          sudo mkdir -p /var/www/html/backups
          if [ -f /var/www/html/index.html ]; then
            sudo cp /var/www/html/index.html /var/www/html/backups/index.html.$TIMESTAMP
            echo "âœ… Backup created: index.html.$TIMESTAMP"
          else
            echo "â„¹ï¸ No existing deployment to backup"
          fi
EOF
    
    - name: Deploy application
      id: deploy
      run: |
        echo "ğŸš€ Deploying application..."
        
        DEPLOYMENT_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        
        # Copy HTML file to server
        scp -i ~/.ssh/deployment-key.pem src/index.html \
          $SSH_USER@${{ steps.instance-info.outputs.instance-ip }}:/tmp/
        
        # Deploy and configure on server
        ssh -i ~/.ssh/deployment-key.pem $SSH_USER@${{ steps.instance-info.outputs.instance-ip }} << 'EOF'
          # Move file to web directory
          sudo mv /tmp/index.html /var/www/html/
          
          # Set proper ownership and permissions
          sudo chown apache:apache /var/www/html/index.html
          sudo chmod 644 /var/www/html/index.html
          
          # Restart Apache
          sudo systemctl restart httpd
          
          # Verify Apache is running
          if sudo systemctl is-active httpd > /dev/null; then
            echo "âœ… Apache is running"
          else
            echo "âŒ Apache failed to start"
            exit 1
          fi
EOF
        
        echo "instance-ip=${{ steps.instance-info.outputs.instance-ip }}" >> $GITHUB_OUTPUT
        echo "deployment-time=$DEPLOYMENT_TIME" >> $GITHUB_OUTPUT
        
        echo "âœ… Deployment completed successfully"
    
    - name: Verify deployment
      run: |
        echo "ğŸ§ª Verifying deployment..."
        
        # Test HTTP response
        HTTP_STATUS=$(ssh -i ~/.ssh/deployment-key.pem $SSH_USER@${{ steps.instance-info.outputs.instance-ip }} \
          "curl -s -o /dev/null -w '%{http_code}' http://localhost")
        
        if [ "$HTTP_STATUS" = "200" ]; then
          echo "âœ… HTTP test passed (Status: $HTTP_STATUS)"
        else
          echo "âŒ HTTP test failed (Status: $HTTP_STATUS)"
          exit 1
        fi
        
        # Verify content
        ssh -i ~/.ssh/deployment-key.pem $SSH_USER@${{ steps.instance-info.outputs.instance-ip }} \
          "curl -s http://localhost | grep -q 'DevOps Learning Journey'"
        
        if [ $? -eq 0 ]; then
          echo "âœ… Content verification passed"
        else
          echo "âŒ Content verification failed"
          exit 1
        fi
        
        echo "ğŸ‰ Deployment verification completed successfully!"

  # Job 3: Post-deployment notification and summary
  notify:
    name: ğŸ“¢ Deployment Summary
    needs: [test, deploy]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Deployment Summary
      run: |
        echo "================================================"
        echo "ğŸš€ DEPLOYMENT SUMMARY"
        echo "================================================"
        echo ""
        echo "ğŸ“Š Job Results:"
        echo "   Tests: ${{ needs.test.result }}"
        echo "   Deployment: ${{ needs.deploy.result }}"
        echo ""
        
        if [ "${{ needs.deploy.result }}" = "success" ]; then
          echo "âœ… Deployment Status: SUCCESS"
          echo "ğŸŒ Application URL: http://${{ needs.deploy.outputs.instance-ip }}"
          echo "ğŸ“… Deployment Time: ${{ needs.deploy.outputs.deployment-time }}"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ“ Message: ${{ github.event.inputs.deploy_message }}"
          fi
        else
          echo "âŒ Deployment Status: FAILED"
          echo "ğŸ“‹ Check the logs above for details"
        fi
        
        echo ""
        echo "ğŸ”§ Useful commands:"
        echo "   View logs: ssh -i key.pem ec2-user@${{ needs.deploy.outputs.instance-ip }} 'sudo tail -f /var/log/httpd/access_log'"
        echo "   Server status: Visit your GitHub repo â†’ Actions â†’ View workflow logs"
        echo ""
        echo "================================================"